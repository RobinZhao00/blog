{"meta":{"title":"Hexo","subtitle":null,"description":null,"author":"å°é©¬è¾¾","url":"http:www.zhaoyua.com"},"pages":[],"posts":[{"title":"å°ç¨‹åºapiçš„promisefy","slug":"å°ç¨‹åºapiçš„promisefy","date":"2018-12-02T05:39:24.000Z","updated":"2018-12-02T07:06:41.675Z","comments":true,"path":"2018/12/02/å°ç¨‹åºapiçš„promisefy/","link":"","permalink":"http:www.zhaoyua.com/2018/12/02/å°ç¨‹åºapiçš„promisefy/","excerpt":"","text":"éœ€æ±‚èƒŒæ™¯ å¾®ä¿¡å°ç¨‹åºçš„å¤§éƒ¨åˆ†apiæ˜¯å¼‚æ­¥çš„ã€‚ ç®€å•åœ°ä¸¾ä¸ªğŸŒ°: wx.showToast(Object object)1234567 wx.showToast(&#123; title: 'æˆåŠŸ', icon: 'success', duration: 2000, success: function(res) &#123; // TODO &#125;, fail: function(err) &#123; // TODO &#125;&#125;); &nbsp;&nbsp;&nbsp;&nbsp;äº‹å®ä¸Šè¿™æ ·çš„api å†™çš„çœŸå¤Ÿå¥½ï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨è€…æ¥è¯´å¹¶ä¸å‹å¥½ã€‚æ‰€ä»¥ï¼Œä¸ºäº†æ–¹ä¾¿åŒäº‹ä»¬æ›´åŠ èˆ’çˆ½åœ°å»å†™ä»£ç ï¼Œäºæ˜¯æˆ‘å¼€å§‹ç¢ç£¨å°è£…ä¸€ä¸ªå°ç¨‹åºapiçš„promisefyçš„å‡½æ•°ã€‚ &nbsp;&nbsp;&nbsp;&nbsp; é‚£ä¹ˆåˆ°åº•æ€ä¹ˆå°è£…å‘¢ï¼Ÿ123456789101112// defaultPropsä¸ºé»˜è®¤å±æ€§ï¼ŒextraPropsä¸ºå®šåˆ¶åŒ–çš„å±æ€§/*** promisefy å¾®ä¿¡å†…ç½®å‡½æ•°* @param fn* @return &#123; promise &#125;*/ const promisefy = fn =&gt; defaultProps =&gt; extraProps =&gt; new Promise((resolve, reject) =&gt; fn(&#123; ...defaultProps, ...extraProps, success: res =&gt; resolve(res), reject: err =&gt; reject(err), &#125;)); &nbsp;&nbsp;&nbsp;&nbsp; é‚£ä¹ˆåˆ°åº•æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ123456789const showToast = promisefy(wx.showToast)(&#123; title: '', icon: \"none\", duration: 2000, confirmColor: '#ff673f', mask: true&#125;);showToast(&#123; title: 'title' &#125;); // å³å¯ä½¿ç”¨ &nbsp;&nbsp;&nbsp;&nbsp; é‚£ä¹ˆè¿™ä¸ªpromisefyè¿˜èƒ½æ€ä¹ˆç”¨å‘¢ï¼Ÿ1.æˆ‘ä»¬å¯èƒ½ä¼šç»å¸¸ä½¿ç”¨storageç›¸å…³çš„apiï¼Œ é‚£ä¹ˆåˆ°åº•æ˜¯æŠŠå¯¹è±¡JSON.stringify, å†setStorageã€‚éœ€è¦ä½¿ç”¨çš„æ—¶å€™å†getStorage, æœ€åJSON.parseå‘¢ï¼Ÿå½“ç„¶è¿™æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚å¦‚æœä½¿ç”¨promisefyï¼Œå¯ä»¥è¿™æ ·å¹²ã€‚123456789101112131415/** * * @param éœ€è¦å¾€LocalStorageé‡Œé¢å­˜æ•°æ® * @returns &#123;Promise&lt;any[] | never&gt;&#125; */const setStorage = (param = &#123;&#125;) =&gt; &#123; if (!Object.keys(param).length) throw new Error('è¾“å…¥çš„å¯¹è±¡ä¸ä¸ºç©º'); return Promise.all(Object.entries(param) .map(item =&gt; promisefy(wx.setStorage)(&#123; key: item[0], data: item[1] &#125;)()));&#125;;setStorage(&#123; a:1, b:2 &#125;); 123456789101112131415/** * * @param éœ€è¦ä»storage è¯»å–çš„keyã€‚ * å•ä¸ªå€¼ç›´æ¥ä¼ string, å¤šä¸ªå€¼ä¼ æ•°ç»„ * eg. ['key1', 'key2', 'key3'] æˆ–è€… 'key1' ; * @returns &#123;key1: value1, key2: value2, key3: key3 &#125; */const getStorage = param =&gt; Promise.all( Object.entries(((typeof param) === 'string') ? [param] : param) .map(item =&gt; promisefy(wx.getStorage)(&#123; key: item[1] &#125;)() .then(res =&gt; (&#123; [`$&#123;item[1]&#125;`]: res.data &#125;)))) .then(res =&gt; res.reduce((prev, curr) =&gt; (&#123; ...prev, ...curr &#125;), &#123;&#125;));getStorage('a'); // &#123; a: 1 &#125;,getStorage(['a', 'b']); // &#123; a: 1, b: 2 &#125;, 123456789/** * @param éœ€è¦ä»storage æ¸…é™¤è®°å½•eg. [key1, key2], key3ã€‚ */const removeStorage = param =&gt; Promise.all( Object.entries(((typeof param) === 'string') ? [param] : param) .map(item =&gt; promisefy(wx.removeStorage)(&#123; key: item[1] &#125;)()));removeStorage('a');removeStorage(['a', 'b']); 2.å¯¹äºæœ‰router çš„é¡µé¢æˆ‘ä»¬ç»å¸¸ä¼šå‡ºç°router çš„ä¸‰ç§è·³è½¬æ–¹æ¡ˆã€‚ä¾‹å¦‚å¾®ä¿¡å°±æä¾›äº†ä¸‰ç§api:navigateToï¼ŒredirectToï¼ŒnavigateBackï¼Œè¿™é‡Œæ²¡æœ‰åŒ…å«å°ç¨‹åºè·³å°ç¨‹åºçš„apiã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å°è£…ä¸€ä¸ªå…¬å…±çš„æ–¹æ³•å‘¢ï¼Ÿ12345678910111213141516171819202122232425262728293031323334353637383940414243// è·¯å¾„å‚æ•°çš„æ‹¼æ¥const obj2Url = params =&gt; &#123; if (params instanceof Array || typeof params === 'number') throw new Error('è·³è½¬å‚æ•°é™åˆ¶äºstringå’Œå¯¹è±¡'); // å¦‚æœè·¯å¾„å‚æ•°ä¸º object, åšä»¥ä¸‹è½¬æ¢ if (typeof params === 'object') &#123; const rawParams = Object.entries(params).reduce((acc, cur) =&gt; &#123; if ((!cur[1]) &amp;&amp; ((typeof cur[1]) !== 'boolean')) console.warn(`$&#123;cur[0]&#125;çš„å€¼ä¸ºç©ºï¼Œ è¯·æ£€æŸ¥åŸå› ï¼`); return `$&#123;acc + cur[0]&#125;=$&#123;cur[1]&#125;&amp;`; &#125;, ''); params = rawParams.substr(0, rawParams.length - 1); &#125; return params;&#125;;/** * * @param page éœ€è¦è·³è½¬çš„é¡µé¢æˆ–è€…é¡µé¢è·¯å¾„(å¦‚æœæ˜¯\"pages/a/b/b\"è¿™æ ·çš„è·¯å¾„ï¼Œpage='pages/a/b/b', specialUrl=true ) * @param type * @param params * @param specialUrl * @return &#123;*&#125; */const jumpTo = (page = 'index', type = 'navigate', params = '', specialUrl = false) =&gt; &#123; const &#123; navigateTo, redirectTo, navigateBack &#125; = wx; const types = &#123; navigate: url =&gt; promisefy(navigateTo)(&#123; url &#125;)(), redirect: url =&gt; promisefy(redirectTo)(&#123; url &#125;)(), back: delta =&gt; promisefy(navigateBack)(&#123; delta &#125;)(), &#125;; params = obj2Url(params); console.log('**test**', 'params', params, `$&#123;page&#125;?$&#123;params&#125;`); if (specialUrl) return types[type](params ? `$&#123;page&#125;?$&#123;params&#125;` : page); // è·å–è·³è½¬å‚æ•°ï¼Œå¦‚æœä¸ºæ•°å­—ï¼Œåˆ™ä¸ºnavigateBackï¼Œåä¹‹ä¸º navigateTo æˆ– navigateBackã€‚ const jumpPram = (typeof page === 'number') ? page : `/pages/$&#123;page&#125;/$&#123;page&#125;$&#123;params ? `?$&#123;params&#125;` : ''&#125;`; console.log(`%c**è·³è½¬å‚æ•°**jumpPram** $&#123;jumpPram&#125;`, 'color:white;background:green'); sendTrack(`**è·³è½¬å‚æ•°**jumpParam** $&#123;jumpPram&#125;`); return types[type](jumpPram);&#125;;jumpTo('a'); // navigateToåˆ°aé¡µé¢jumpTo('a', 'navigate', &#123; m: 'm' &#125;); // navigateToåˆ°aé¡µé¢ ,è·¯å¾„å‚æ•°ä¸º?m=mjumpTo('a', 'redirect', &#123; m: 'm' &#125;); // redirectToåˆ°aé¡µé¢ ,è·¯å¾„å‚æ•°ä¸º?m=mjumpTo(1, 'redirect', &#123; m: 'm' &#125;); // back ä¸Šä¸€æ­¥ ,è·¯å¾„å‚æ•°ä¸º?m=m é¡¹ç›®å®è·µ 1.native å°ç¨‹åºå¼€å‘è€…ã€‚ï¼ˆä¸‹è½½babel-polyfillï¼Œå¯¼å…¥regeneratorRuntimeï¼‰ 1234567891011121314151617181920212223242526272829303132333435import regeneratorRuntime from 'ä½ æ”¾ç½®çš„æ–‡ä»¶å¤¹';const showLoading = promisefy(wx.showLoading)(&#123; title: 'åŠ è½½ä¸­', mask: true &#125;);const hideLoading = () =&gt; wx.hideLoading();const showMoshowToast = promisefy(wx.showToast)(&#123; title: 'title', content: '', mask: true &#125;);const Loading = &#123; show: showLoading, hide: hideLoading &#125;;const Toast = &#123; show: showToast &#125;;const handleErr = (e, cb) =&gt; &#123; Loading.hide(); if ((typeof e) === 'string') &#123; Toast.show(&#123; title: e || 'æœåŠ¡å™¨å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•' &#125;); &#125; else &#123; const &#123; message &#125; = e; Toast.show(&#123; title: message || 'æœåŠ¡å™¨å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•' &#125;); &#125; cb &amp;&amp; cb();&#125;;const fetchData = () =&gt; &#123;&#125;aync function() &#123; try &#123; await Loading.show(); const &#123; data &#125; = await fetchData(); this.setData(&#123; data &#125;) Loading.hide(); &#125; catch (e) &#123; handleErr(e) &#125;&#125; 2.webpackå’Œtaro ç”¨æˆ·ç›´æ¥å¼•å…¥ç”¨é…ç½®bable ç›¸å…³npmå³å¯, å¯å‚è€ƒ æ€»ç»“åˆ†æ å‡½æ•°çš„ç§‘é‡ŒåŒ–å¹²äº†ä»€ä¹ˆï¼Ÿ &nbsp;&nbsp;&nbsp;&nbsp;å‚è€ƒ ç§‘é‡ŒåŒ– æ€ä¹ˆé¿å…è¿‡å¤šä½¿ç”¨switchâ€¦case,ifâ€¦elseç­‰ï¼Ÿ &nbsp;&nbsp;&nbsp;&nbsp;å‚è€ƒ ç­–ç•¥æ¨¡å¼ æ‰å¹³åŒ–æ•°ç»„æ“ä½œã€‚ &nbsp;&nbsp;&nbsp;&nbsp;å‚è€ƒ ç¼–å†™æ‰å¹³åŒ–çš„ä»£ç  å¼‚å¸¸çš„å¤„ç†ã€‚","categories":[],"tags":[]}]}